---
title: "Analyze Eigen Gene QTL"
output: html_notebook
author: "Julin Maloof"
---


Previous script: "get_eigengene_QTL.Rmd"

The goal is to find QTL peaks for the WGCNA eigen genes and see if those overalp with any growth QTL.  We are only focusing on eigen genes that correlated with some growth traits/paramters.

```{r}
library(qtl)
library(tidyverse)
library(stringr)
load("scanone-eigengene-qtl.RData")
```

## Plot QTL

```{r}

threshold.99 <- tibble(perm.threshold=lod.thrs[1,],
                       trait=colnames(lod.thrs))

scanone.gather <- scanone_eigen %>%
  gather(key = trait, value = LOD, -chr, -pos) %>%
  mutate(condition=str_sub(trait,1,2), color=str_sub(trait,6,100)) %>%
  left_join(threshold.99)

scanone.gather
```

```{r}
pl.CR <- scanone.gather %>% filter(condition=="CR") %>%
  ggplot(aes(x=pos,y=LOD)) +
  geom_line() +
  geom_hline(aes(yintercept=perm.threshold),lty=2,lwd=.5,alpha=.5) +
  facet_grid(trait ~ chr, scales="free") +
  theme(strip.text.y = element_text(angle=0), axis.text.x = element_text(angle=90)) +
  ggtitle("CR Eigen Gene QTL")
pl.CR
```

```{r}
   pl.UN <- scanone.gather %>% filter(condition=="UN") %>%
  ggplot(aes(x=pos,y=LOD)) +
  geom_line() +
  geom_hline(aes(yintercept=perm.threshold),lty=2,lwd=.5,alpha=.5) +
  facet_grid(trait ~ chr, scales="free") +
  theme(strip.text.y = element_text(angle=0), axis.text.x = element_text(angle=90)) +
  ggtitle("UN Eigen Gene QTL")
pl.UN
```

All together

```{r, fig.height=10}
pl.all <- scanone.gather %>%
  ggplot(aes(x=pos,y=LOD)) +
  geom_line() +
  geom_hline(aes(yintercept=perm.threshold),lty=2,lwd=.5,alpha=.5) +
  facet_grid(trait ~ chr, scales="free") +
  theme(strip.text.y = element_text(angle=0), axis.text.x = element_text(angle=90)) +
  ggtitle("Eigen Gene QTL")
pl.all
```

## Look for overlap

For each eigen gene, find QTL borders and look for overlap with growth QTL

For each eigen gene first identify chromosomes with "significant" peaks (in this case > 99% permuation threshold) and then runs bayesint() on them to define the intervals

```{r}
sig.chrs <- scanone.gather %>% filter(LOD > perm.threshold) %>%
  group_by(trait,chr) %>%
  summarize(unique(chr))
sig.chrs
```

now for each significant chromosome/trait combo run bayesint

```{r}
bayesint.list <- apply(sig.chrs,1,function(hit) {
  bayesint(scanone_eigen, 
           chr=hit["chr"], 
           lodcolumn = which(str_detect(hit["trait"],names(cross.all$pheno)))-1,
           expandtomarkers = TRUE
           )
})
names(bayesint.list) <- sig.chrs$trait

bayesint.list <- lapply(bayesint.list,function(x) x %>% 
                          as.data.frame() %>%
                          rownames_to_column(var="markername")
)

bayesint.result <- as.tibble(bind_rows(bayesint.list,.id="trait")) %>% 
  select(trait,chr,pos,markername) %>%
  separate(markername,into=c("chr1","Mbp"),sep="x", convert=TRUE) %>%
  group_by(trait,chr) %>%
  summarize(start=min(Mbp),end=max(Mbp)) %>%
  #for the high QTL peaks the interval width is 0.  That is overly precise and need to widen those.
  mutate(start=ifelse(start==end,max(0,start-20000),start), end=ifelse(start==end,end+20000,end))
  
  
bayesint.result
```

### annotate Eigen gene QTL

Load annotation
```{r}
BrapaAnnotation <- read_csv("Brapa_V1.5_annotated.csv")
BrapaAnnotation
```

```{r}
eigen.annotated <- lapply(1:nrow(bayesint.result),function(row) {
  qtl <- bayesint.result[row,]
  results <- subset(BrapaAnnotation, chrom==qtl$chr &
                    start >= qtl$start &
                    end <= qtl$end)
}
)
names(eigen.annotated) <- bayesint.result$trait
eigen.annotated <- bind_rows(eigen.annotated,.id="trait")
eigen.annotated
eigen.annotated.small <- eigen.annotated %>% select(trait,name)
```

given bayesint results, find overlaps with CR and UN growth QTL

```{r}
QTLgenes <- read_csv("~/Box Sync/BrapaNetworks/Heigh2012_uniquegenes.csv")[,-1] #genes under height QTL peaks
QTLgenes
```

```{r}
eigen.qtl.combined <- left_join(QTLgenes,eigen.annotated.small) %>%
  select(.id, trait, everything())
eigen.qtl.combined
```

how many QTL have at least some overlap?
```{r}
unique(QTLgenes$.id)
unique(eigen.qtl.combined$.id)
```

All...

Ooooh we are in a bit of a circular conundrum here.  Are these explanatory or is it just genetic linkage?

are all eigen genes overlapping?

```{r}
unique(eigen.annotated.small$trait)
unique(eigen.qtl.combined$trait)
```

No...

```{r}
write_csv(eigen.qtl.combined,"Heigh2012_uniquegenes_eigenQTL_overlap.csv")
```

